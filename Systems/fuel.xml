<?xml version="1.0"?>  

<!-- c182s fuel system according to POH 7-25
The left and right wing are connected to the fuel selector valve. both tanks have a drain valve.
The fuel selector has a small fuel sump which is fed from the selected tanks using gravity.
From there the fuel flows to a strainer (also with small sump) and to the electrical aux pump
and then to the mechanical (enginge driven) pump which pumps it to the fuel/air control unit.
At the fuel/air unit sits the fuel flow meter. From there the fuel is delivered to the engines
intake manifods.

Implementation notice:
- The idea is to treat every item that holds fuel as independent tank.
- The tanks have drains: /controls/fuel/tank[n]/drain-valve (1=open/0=shut)
- Switches define possible valves and define the ammount and conditions of flow.
- Summers define the outflow/inflow of the whole tank and depend on linked valves;
  they are just there to let jsbsim handle the content ammount. This way a tank can
  simultaneously be drained+refuelled+whatever.
-->
<system name="fuel">
    
    <property type="bool" value="0">/controls/fuel/tank[0]/drain-valve</property>
    <property type="bool" value="0">/controls/fuel/tank[1]/drain-valve</property>
    <property type="bool" value="0">/controls/fuel/tank[2]/drain-valve</property>
    <property type="bool" value="0">/controls/fuel/tank[3]/drain-valve</property>
    
    <property type="bool" value="1">/systems/fuel/fuel-pump-aux-serviceable</property>
    <property type="bool" value="1">/systems/fuel/fuel-pump-engine-serviceable</property>

    
    <channel name="fuel-system">
        <!-- property: /fdm/jsbsim/propulsion/tank[n]/external-flow-rate-pps -->
       
        
        <!-- ######################### -->
        <!-- ###### 0: LEFT TANK ##### -->
        <!-- ######################### -->
        <switch name="fuel/left-tank-drain-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="25">
                /controls/fuel/tank[0]/drain-valve EQ 1
            </test>
        </switch>
        <switch name="fuel/left-tank-tofuelselector-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="0.10">
                <test logic="AND">
                    /fdm/jsbsim/propulsion/tank[0]/pct-full  GT    0.0
                    /fdm/jsbsim/propulsion/tank[2]/pct-full  LT  100.0
                </test>
                <test logic="OR">
                    <!-- fuel selector position: 0=off, 1=right, 2=both, 3=left -->
                    /controls/switches/fuel_tank_selector EQ 3
                    /controls/switches/fuel_tank_selector EQ 2 
                </test>
            </test>
        </switch>
 
        <summer>
            <input>-fuel/left-tank-drain-flow-rate-pps</input>
            <input>-fuel/flow-left-right-transfer-pps</input>
            <input>-fuel/left-tank-tofuelselector-flow-rate-pps</input>
            <output>/fdm/jsbsim/propulsion/tank[0]/external-flow-rate-pps</output>
        </summer>
        
        
        
        
        <!-- ########################## -->
        <!-- ###### 1: RIGHT TANK ##### -->
        <!-- ########################## -->
        <switch name="fuel/right-tank-drain-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="25">
                /controls/fuel/tank[1]/drain-valve EQ 1
            </test>
        </switch>
        <switch name="fuel/right-tank-tofuelselector-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="0.10">
                <test logic="AND">
                    /fdm/jsbsim/propulsion/tank[1]/pct-full  GT    0.0
                    /fdm/jsbsim/propulsion/tank[2]/pct-full  LT  100.0
                </test>
                <test logic="OR">
                    <!-- fuel selector position: 0=off, 1=right, 2=both, 3=left -->
                    /controls/switches/fuel_tank_selector EQ 1
                    /controls/switches/fuel_tank_selector EQ 2 
                </test>
            </test>
        </switch>
        
        <summer>
            <input>-fuel/right-tank-drain-flow-rate-pps</input>
            <input>-fuel/right-tank-tofuelselector-flow-rate-pps</input>
            <input>fuel/flow-left-right-transfer-pps</input>
            <output>/fdm/jsbsim/propulsion/tank[1]/external-flow-rate-pps</output>
        </summer>
        
        
        
        
        <!-- TRANSFER BETWEEN TANKS -->
        <!-- when the fuel selection lever is BOTH, the tanks should slowly level out. -->
        <!-- TODO: TAKE POSITION AND GRAVITY INTO ACCOUNT!!! When the plane stands uneven, one tank may become more filled than the other! -->
        <!-- TODO: flow rate of 1pps is arbitary! -->
        <switch name="fuel/flow-left-right-transfer-pps">
            <default value="0"/>
            <test logic="AND" value="1">
                /fdm/jsbsim/propulsion/tank[0]/pct-full GT 0.0
                /fdm/jsbsim/propulsion/tank[0]/pct-full GT /fdm/jsbsim/propulsion/tank[1]/pct-full
                /fdm/jsbsim/propulsion/tank[1]/pct-full LT 100.0
                /controls/switches/fuel_tank_selector EQ 2
            </test>
            <test logic="AND" value="-1">
                /fdm/jsbsim/propulsion/tank[1]/pct-full GT 0.0
                /fdm/jsbsim/propulsion/tank[1]/pct-full GT /fdm/jsbsim/propulsion/tank[0]/pct-full
                /fdm/jsbsim/propulsion/tank[0]/pct-full LT 100.0
                /controls/switches/fuel_tank_selector EQ 2
            </test>
        </switch>

        
        
        
        <!-- ################################# -->
        <!-- ##### 2: FUEL SELECTOR SUMP ##### -->
        <!-- ################################# -->
        <switch name="fuel/fuel-selector-sump-drain-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="25">
                /controls/fuel/tank[2]/drain-valve EQ 1
            </test>
        </switch>
        <switch name="fuel/fuel-selector-tofuelstrainer-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="0.10">
                /fdm/jsbsim/propulsion/tank[2]/pct-full  GT    0.0
                /fdm/jsbsim/propulsion/tank[3]/pct-full  LT  100.0
            </test>
        </switch>
        
        <summer>
            <input>fuel/left-tank-tofuelselector-flow-rate-pps</input>
            <input>fuel/right-tank-tofuelselector-flow-rate-pps</input>
            <input>-fuel/fuel-selector-tofuelstrainer-flow-rate-pps</input>
            <input>-fuel/fuel-selector-sump-drain-flow-rate-pps</input>
            <output>/fdm/jsbsim/propulsion/tank[2]/external-flow-rate-pps</output>
        </summer>

        
        
        
        <!-- ################################# -->
        <!-- ##### 3: FUEL STRAINER SUMP ##### -->
        <!-- ################################# -->
        <switch name="fuel/fuel-strainer-sump-drain-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="25">
                /fdm/jsbsim/propulsion/tank[3]/pct-full    GT  0.0
                /controls/fuel/tank[3]/drain-valve EQ  1
            </test>
        </switch>
        <switch name="fuel/fuel-strainer-tofuelpipe-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="0.10">
                /fdm/jsbsim/propulsion/tank[3]/pct-full  GT    0.0
                /fdm/jsbsim/propulsion/tank[4]/pct-full  LT  100.0
                accelerations/Nz GE -0.5
            </test>
        </switch>
        
        <summer>
            <input>fuel/fuel-selector-tofuelstrainer-flow-rate-pps</input>
            <input>-fuel/fuel-strainer-tofuelpipe-flow-rate-pps</input>
            <input>-fuel/fuel-strainer-sump-drain-flow-rate-pps</input>
            <output>/fdm/jsbsim/propulsion/tank[3]/external-flow-rate-pps</output>
        </summer>

        
        
        <!-- ####################### -->
        <!-- ##### 4: FUEL PIPE #### -->
        <!-- ####################### -->
        <summer>
            <input>fuel/fuel-strainer-tofuelpipe-flow-rate-pps</input>
            <input>-fuel/pump-flow-rate-pps</input>
            <output>/fdm/jsbsim/propulsion/tank[4]/external-flow-rate-pps</output>
        </summer>
        
            
            
        <!-- ####################### -->
        <!-- ##### FUEL PUMPING #### -->
        <!-- ####################### -->
        <!-- The fuel pumps fill the manifold. Fill rate >50% means engine flooded. -->
        <switch name="fuel/pump-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="0.10">
                <!-- engine on: mechanical pump OR aux pump active -->
                <test logic="OR">
                    <test logic="AND">
                        /fdm/jsbsim/propulsion/engine/set-running  EQ   1
                        /systems/fuel/fuel-pump-engine-serviceable EQ   1
                    </test>
                    <test logic="AND">
                        /systems/electrical/outputs/fuel-pump      GT   0
                        /systems/fuel/fuel-pump-aux-serviceable    EQ   1
                    </test>
                </test>
                <test logic="AND">
                    /fdm/jsbsim/propulsion/tank[4]/pct-full    GT   0.0
                    /fdm/jsbsim/propulsion/tank[5]/pct-full    LT  50.0
                </test>
            </test>
            <test logic="AND" value="0.025">
                <!-- engine off: aux pump on and powered? -->
                /fdm/jsbsim/propulsion/engine/set-running  EQ   0
                /systems/electrical/outputs/fuel-pump      GT   0
                /systems/fuel/fuel-pump-aux-serviceable    EQ   1
                /fdm/jsbsim/propulsion/tank[4]/pct-full    GT   0.0
                /fdm/jsbsim/propulsion/tank[5]/pct-full    LT 100.0
            </test>
        </switch>

         
        <!-- ###################### -->
        <!-- ##### 5: MANIFOLD #### -->
        <!-- Engine sucks here (max=0.035pps). The only inflow can come from an active pump. -->
        <!-- Special is also, that the mechanical pump can only fill this tank to 50%. -->
        <!-- The electrical pump can fill it to more than that; whereas a threshold signals "engine flooded" -->
        <summer>
            <input>fuel/pump-flow-rate-pps</input>
            <input>-/fdm/jsbsim/propulsion/engine/fuel-flow-rate-pps</input>
            <output>/fdm/jsbsim/propulsion/tank[5]/external-flow-rate-pps</output>
        </summer>
    
    </channel>

</system>
