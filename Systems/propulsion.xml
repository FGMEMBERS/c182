<?xml version="1.0"?>
<!-- based on  HAL V. Engel's p51d, tuning by Heiko H. Schulz; oil managament additions made by Benedikt Hallinger 2017/ 2018 -->

<system name="Propulsion">
    
    <property type="double" value="0">oil-powergain-factor-calc</property>

    <channel name="engine power">
    

<!--controls fuel flow depending on density altitude-->
-<fcs_function name="systems/engine/MP-alt-volumetric-efficiency-curve">
          <function>
                <table>
                    <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                    <independentVar lookup="column">propulsion/engine/map-inhg</independentVar>
                    <tableData breakPoint="0">
			14	15	16	17	18	19	20	21	22	23	24	25	26	27	28	28.5
		0	0.15	0.83	0.84	0.85	0.86	0.88	0.88	0.88	0.88	0.88 0.88	0.88	0.89	0.88	0.88 0.88
		2000	0.15	0.780	0.780	0.780	0.780	0.780	0.790	0.85	0.86	0.87	0.88	0.88	0.88	0.88	0.88	0.88   
		4000	0.15	0.847	0.847	0.847	0.847	0.847	0.847	0.848	0.855	0.862	0.87	0.87	0.87	0.87	0.87	0.87
		6000	0.15	0.855	0.855	0.855	0.855	0.855	0.855	0.86	0.87	0.88	0.88	0.88	0.88	0.88	0.88	0.88	  
		8000	0.15	0.865	0.865	0.865	0.865	0.865	0.865	0.87	0.87	0.87	0.87	0.87	0.87	0.87	0.87	0.87	
		10000 0.15	0.85	0.85	0.85	0.85	0.86	0.86	0.86	0.86	0.86	0.86	0.86	0.86	0.86	0.86	0.86   
		12000 0.15	0.84	0.84	0.85	0.855	0.855	0.855	0.855	0.855	0.855	0.855	0.855	0.855	0.855	0.855	0.855	 
		14000 0.15	0.86	0.86	0.86	0.86	0.86	0.86	0.86	0.86	0.86	0.86	0.86	0.86	0.86	0.86	0.86   
                   </tableData> 
                </table>  
          </function>
          <output>propulsion/engine/volumetric-efficiency</output>   
        </fcs_function>

 <!--controls power depending on density altitude-->
<fcs_function name="systems/engine/MP-alt-bsfc-lbs_hphr-curve">
          <function>
                <table>
                    <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                    <independentVar lookup="column">propulsion/engine/map-inhg</independentVar>
                    <tableData breakPoint="0">
				15	16	17	18	19	20	21	22	23	24	25	26	27	28	28.5
		0		0.34	0.34	0.34	0.34	0.34	0.34	0.34	0.34	0.34	0.34	0.34	0.34	0.34 0.450 0.450
		2000		0.315	0.315	0.315	0.315	0.315	0.315	0.315	0.315	0.325	0.335	0.345	0.355	0.365	0.425	0.439		
		4000		0.34	0.34	0.34	0.34	0.34	0.34	0.34 0.34 0.34 0.34 0.425 0.425 0.428 0.428 0.428	
		6000		0.372	0.372	0.372	0.372	0.372	0.3620.352	0.342	0.332	0.342	0.352	0.412	0.422	0.422	0.422
		8000		0.325	0.325	0.325	0.325	0.325	0.325	0.335	0.34	0.35	0.364	0.404	0.414	0.414	0.414	0.414
		10000	0.317	0.317	0.317	0.317	0.327	0.337	0.347	0.357	0.367	0.409	0.409	0.409	0.409	0.409	0.409	 
		12000	0.304	0.314	0.324	0.334	0.344	0.353	0.363	0.373	0.383	0.393	0.403	0.413	0.413	0.413	0.413	
		14000	0.33	0.33	0.34	0.35	0.36	0.375	0.385	0.395	0.405	0.405	0.405	0.405	0.405	0.405	0.405
                   </tableData>
                </table>  
          </function>
          <clipto>
             <min> 0.0 </min>
             <max> 1.00 </max>
           </clipto>
          <output>propulsion/engine/bsfc-lbs_hphr</output>   
        </fcs_function>
	
 <fcs_function name="systems/engine/RAM-Air-Factor">
          <function>
                <table>
                    <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                    <tableData breakPoint="0">
					
                        0		0.1		
                        2000	0.2		
                        4000	0.3		
                        6000	0.6		
                        8000	0.9		
                        10000	0.99		 
                        12000	0.99	
                        14000	0.99	
                   </tableData>
                </table>  
          </function>
          <clipto>
             <min> 0.0 </min>
             <max> 1.00 </max>
           </clipto>
          <output>propulsion/engine/ram-air-factor</output>   
        </fcs_function>
        
        
        <!-- OIL Power gain factor -->
        <!-- (cold oil makes the engine output less power due to reduced viscosity/increased friction) -->
        <!-- This also simulates "running the engine warm" -->
        <switch name="engines/engine/oil-powergain-factor">
            <default value="1"/>
            <test logic="AND" value="oil-powergain-factor-calc">
                /engines/engine/complex-engine-procedures EQ 1
                /engines/engine/allow-oil-management EQ 1
                /sim/start-state-internal/oil-temp-override EQ 0
            </test>
            <output>/engines/engine/oil-powergain-factor</output>
        </switch>
        <fcs_function name="oil-powergain-factor-calc">
            <function>
                <table>
                    <independentVar lookup="row">/engines/engine/oil-final-temperature-degf</independentVar>
                    <tableData breakPoint="0">
                        19.4   2.00   <!-- -7°C -->
                        90.0   1.00   <!-- 32°C --> <!-- engine is considered "hot" -->
                    </tableData>
                </table>  
            </function>
            <clipto>
                <min> 1.0 </min>  <!-- 1=no more better; <1 is boost! -->
                <max> 1.5 </max>  <!-- bigger=less power -->
            </clipto>
            <output>oil-powergain-factor-calc</output>
        </fcs_function>

    </channel>
</system>
