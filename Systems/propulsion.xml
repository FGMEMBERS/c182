<?xml version="1.0"?>
<!-- based on  HAL V. Engel's p51d, tuning by Heiko H. Schulz; oil managament additions made by Benedikt Hallinger 2017/ 2018 -->

<system name="Propulsion">
    
    <property type="double" value="0">oil-powergain-factor-calc</property>
   

    <channel name="engine power">
  	
<fcs_function name="systems/engine/MP-alt-volumetric-efficiency-curve">
          <function>
                <table>
                    <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                    <independentVar lookup="column">propulsion/engine/map-inhg</independentVar>
                    <tableData breakPoint="0">
			14 	15	16	17	18	19	20	21	22	23	24	25	26	27	28	28.5
		0	0.15	 0.85 0.85	0.85 	0.85 0.85 0.85 0.85 0.92 0.87 0.865 0.855 0.855 0.855 0.945 1.045 
		2000	0.15	0.86 0.86 0.86 0.86 0.86 0.86 0.86 0.86 0.85 0.85 0.86 0.86 0.965 1.065 1.065   
		4000	0.15 0.87 0.87 0.87 0.87 0.870.87 0.87 0.86 0.85 0.85  0.97 0.980 1.080 1.080 1.080
		6000	0.15 0.850	0.850	0.850	0.850	0.85	 0.85 0.85	 0.85	 0.85 0.86	1.08 	1.080 1.080 1.078 1.080	  
		8000	0.15 0.860	0.860	0.860	0.860	0.860	 0.860 0.850  0.80 0.80  0.90	0.90 	0.90 0.90	0.90	0.90	
		10000 0.15 0.835	0.835	0.835	0.835	0.835	0.835	0.77	0.77	0.87 0.87	0.87  0.87 0.87 0.87 0.87   
		12000 0.15 0.85	0.85	0.85	0.85 0.79 0.79  0.79 0.79 0.89 0.89 0.89	0.89  0.89 0.89 0.89 
		14000 0.15 0.835 0.835 0.83 0.77 0.77 0.77 0.77 0.87 0.87 0.87 0.87 0.87  0.87 0.87 0.87 
                   </tableData> 
                </table>  
          </function>
          <output>propulsion/engine/volumetric-efficiency</output>   
        </fcs_function>
	
<!--controls fuel flow depending on density altitude
-<fcs_function name="systems/engine/MP-alt-volumetric-efficiency-curve">
          <function>
                <table>
                    <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                    <independentVar lookup="column">propulsion/engine/map-inhg</independentVar>
                    <tableData breakPoint="0">
			14	15	16	17	18	19	20	21	22	23	24	25	26	27	28	28.5
		0	0.15	0.25	0.36	0.46	0.56	0.66	0.761	0.763	0.764	0.772 0.78	0.79	0.78	0.80	0.86 0.88
		2000	0.15	0.280	0.380	0.480	0.580	0.680	0.780	0.780	0.790	0.800	0.804	0.81	0.8	0.785	0.885	0.86   
		4000	0.15	0.747	0.747	0.747	0.747	0.747	0.747	0.748	0.755	0.762	0.77	0.77	0.77	0.77	0.77	0.77
		6000	0.15	0.755	0.755	0.755	0.755	0.755	0.755	0.76	0.77	0.78	0.78	0.78	0.78	0.78	0.78	0.78	  
		8000	0.15	0.765	0.765	0.765	0.765	0.765	0.765	0.77	0.77	0.77	0.77	0.77	0.77	0.77	0.77	0.77	
		10000 0.15	0.75	0.75	0.75	0.75	0.76	0.76	0.76	0.76	0.76	0.76	0.76	0.76	0.76	0.76	0.76   
		12000 0.15	0.74	0.74	0.75	0.755	0.755	0.755	0.755	0.755	0.755	0.755	0.755	0.755	0.755	0.755	0.755	 
		14000 0.15	0.76	0.76	0.76	0.76	0.76	0.76	0.76	0.76	0.76	0.76	0.76	0.76	0.76	0.76	0.76   
                   </tableData> 
                </table>  
          </function>
          <output>propulsion/engine/volumetric-efficiency</output>   
        </fcs_function>-->
	
 <!--controls power depending on density altitude
<fcs_function name="systems/engine/MP-alt-bsfc-lbs_hphr-curve">
          <function>
                <table>
                    <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                    <independentVar lookup="column">propulsion/engine/map-inhg</independentVar>
                    <tableData breakPoint="0">
				15	16	17	18	19	20	21	22	23	24	25	26	27	28	28.5
		0		0.375	0.375	0.375	0.375	0.375	0.375	0.35	0.34	0.33	0.32	0.31	0.30	0.31 0.443 0.443
		2000		0.355	0.355	0.355	0.355	0.355	0.355	0.355	0.365	0.37	0.375	0.385	0.395	0.428	0.428	0.428		
		4000		0.34	0.34	0.34	0.34	0.34	0.34	0.34 0.34 0.40 0.425 0.425 0.425 0.428 0.428 0.428	
		6000		0.355	0.355	0.355	0.355	0.355	0.355	0.355	0.355	0.362	0.392	0.392	0.412	0.422	0.422	0.422
		8000		0.37	0.37	0.37	0.37	0.37	0.37	0.37	0.37	0.374	0.394	0.414	0.414	0.414	0.414	0.414
		10000	0.362	0.362	0.362	0.362	0.362	0.362	0.362	0.362	0.374	0.409	0.409	0.409	0.409	0.409	0.409	 
		12000	0.359	0.359	0.359	0.359	0.359	0.363	0.373	0.383	0.393	0.403	0.413	0.413	0.413	0.413	0.413	
		14000	0.359	0.359	0.359	0.369	0.370	0.375	0.385	0.395	0.405	0.405	0.405	0.405	0.405	0.405	0.405
                   </tableData>
                </table>  
          </function>
          <clipto>
             <min> 0.0 </min>
             <max> 1.00 </max>
           </clipto>
          <output>propulsion/engine/bsfc-lbs_hphr</output>   
        </fcs_function>-->




<!-- Power based on fuel flow-->
<fcs_function name="systems/engine/MP-alt-bsfc-lbs_hphr-curve">
          <function>
	     <product>
                <table>
                    <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                    <independentVar lookup="column">propulsion/engine/fuel-flow-rate-gph</independentVar>
                    <tableData breakPoint="0">
				8.0	9.0	13.5	14.5	15.5	16.5	17.5	19.0	20.5	21.5
		0		0.360	0.360	0.36	0.415	0.425	0.425	0.437	0.455	0.475 0.53
		2000		0.355	0.355	0.355	0.415	0.425	0.425	0.457	0.475	0.53 0.53
		4000		0.360	0.360	0.340	0.415	0.425	0.425	0.437	0.53	0.53 0.53
		6000		0.332	0.332	0.357	0.415	0.425	0.425	0.53	0.53	0.53 0.53
		8000		0.365	0.365	0.355	0.415	0.425	0.425	0.53	0.53	0.53 0.53
		10000	0.280	0.280	0.415	0.415	0.437	0.53	0.53	0.53	0.53 0.53
		12000	0.270	0.315	0.415	0.435	0.53	0.53	0.53	0.53	0.53 0.53
		14000	0.345	0.337	0.445	0.53	0.53	0.53 0.53 0.53	0.53 0.53
                   </tableData>
                </table>  
                <property>/engines/engine/oil-powergain-factor</property>
                </product>
          </function>
          <clipto>
             <min> 0.0 </min>
             <max> 1.00 </max>
           </clipto>
          <output>propulsion/engine/bsfc-lbs_hphr</output>   
        </fcs_function>
	
 <fcs_function name="systems/engine/RAM-Air-Factor">
          <function>
                <table>
                    <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                    <tableData breakPoint="0">
					
                        0		0.1		
                        2000	0.2		
                        4000	0.3		
                        6000	0.6		
                        8000	0.9		
                        10000	0.99		 
                        12000	0.99	
                        14000	0.99	
                   </tableData>
                </table>  
          </function>
          <clipto>
             <min> 0.0 </min>
             <max> 1.00 </max>
           </clipto>
          <output>propulsion/engine/ram-air-factor</output>   
        </fcs_function>
	
	
<!--<fcs_function name="systems/engine/Air-Intake-Impedance-Factor">
          <function>
                <table>
                    <independentVar lookup="row">atmosphere/density-altitude</independentVar>
                    <tableData breakPoint="0">
                        0		0.2		
		5000		0.2		
		14000	-0.0	
                   </tableData>
                </table>  
          </function>
          <output>propulsion/engine/air-intake-impedance-factor</output>   
        </fcs_function>-->
	
   
        
        
        <!-- OIL Power gain factor -->
        <!-- (cold oil makes the engine output less power due to reduced viscosity/increased friction) -->
        <!-- This also simulates "running the engine warm" -->
        <switch name="engines/engine/oil-powergain-factor">
            <default value="1"/>
            <test logic="AND" value="oil-powergain-factor-calc">
                /engines/engine/complex-engine-procedures EQ 1
                /engines/engine/allow-oil-management EQ 1
                /sim/start-state-internal/oil-temp-override EQ 0
            </test>
            <output>/engines/engine/oil-powergain-factor</output>
        </switch>
        <fcs_function name="oil-powergain-factor-calc">
            <function>
                <table>
                    <independentVar lookup="row">/engines/engine/oil-final-temperature-degf</independentVar>
                    <tableData breakPoint="0">
                        19.4   2.00   <!-- -7°C -->
                        90.0   1.00   <!-- 32°C --> <!-- engine is considered "hot" -->
                    </tableData>
                </table>  
            </function>
            <clipto>
                <min> 1.0 </min>  <!-- 1=no more better; <1 is boost! -->
                <max> 1.5 </max>  <!-- bigger=less power -->
            </clipto>
            <output>oil-powergain-factor-calc</output>
        </fcs_function>

    </channel>
</system>
